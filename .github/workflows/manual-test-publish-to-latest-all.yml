name: Manual Publish or Restore latest-all.xml

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (revert latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # IMPORTANT for HEAD~1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Publish ----------
      - name: Install Python
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

      - name: Commit publish
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -e
          FILE="docs/${{ inputs.filename || 'latest-all.xml' }}"
          git add "$FILE"
          if [ "${{ inputs.also_underscore }}" = "true" ]; then
            git add docs/latest_all.xml || true
          fi
          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}" || echo "No changes to commit"
          git push

      # ---------- Restore ----------
      - name: Restore previous file (RestorePrevious mode)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          FILE: docs/${{ inputs.filename || 'latest-all.xml' }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -e

          echo "Restoring previous version of: $FILE"
          echo "Current HEAD: $(git rev-parse --short HEAD)"
          echo "Commit count: $(git rev-list --count HEAD)"

          # Ensure we have at least one previous commit
          if [ "$(git rev-list --count HEAD)" -lt 2 ]; then
            echo "Not enough history to restore previous version. Ensure checkout uses fetch-depth: 0."
            exit 1
          fi

          # Confirm file existed in previous commit
          if ! git ls-tree -r --name-only HEAD~1 | grep -qx "$FILE"; then
            echo "Previous commit does not contain $FILE. Nothing to restore."
            exit 0
          fi

          # Show diff for troubleshooting
          echo "---- DIFF vs previous ----"
          git diff --stat HEAD~1 -- "$FILE" || true
          echo "--------------------------"

          # Restore from previous commit
          git restore --source=HEAD~1 -- "$FILE"
          git add "$FILE"

          # Optional underscore companion
          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            UNDERSCORE="docs/latest_all.xml"
            if git ls-tree -r --name-only HEAD~1 | grep -qx "$UNDERSCORE"; then
              git restore --source=HEAD~1 -- "$UNDERSCORE"
              git add "$UNDERSCORE"
              echo "Restored $UNDERSCORE as well."
            else
              echo "No previous version of $UNDERSCORE found; skipping."
            fi
          fi

          # Commit/push (no-op if identical)
          git commit -m "restore previous: $FILE" || echo "No changes to commit"
          git push || echo "No changes pushed"
          echo "Restore step complete."
