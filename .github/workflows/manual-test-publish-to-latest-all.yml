name: Manual Publish or Restore

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (copy latest.xml â†’ latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Publish ----------
      - name: Validate inputs (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -e
          if [ -z "${{ inputs.ship }}" ] || [ -z "${{ inputs.event }}" ] || [ -z "${{ inputs.port }}" ] || [ -z "${{ inputs.est }}" ]; then
            echo "Missing one or more required inputs: ship, event, port, est"
            exit 1
          fi

      - name: Install Python
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
        run: |
          set -euo pipefail
          echo "Writing to: $TARGET_FILE"
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            --nonce "${{ github.run_id }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

          echo "---- HEAD of file after write ----"
          sed -n '1,80p' "$TARGET_FILE" || true
          echo "----------------------------------"

      - name: Commit publish
        if: ${{ inputs.mode == 'Publish' }}
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -euo pipefail
          git status --porcelain
          if git diff --quiet -- "$TARGET_FILE"; then
            echo "::error ::No changes detected in $TARGET_FILE after publisher ran."
            exit 1
          fi

          git add "$TARGET_FILE"
          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            git add docs/latest_all.xml || true
          fi

          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}"
          git push
          echo "Publish committed & pushed."

      - name: Notify Power Automate (Publish mode)
        if: ${{ inputs.mode == 'Publish' }}
        env:
          FLOW_URL: ${{ secrets.FLOW_URL }}
          FLOW_SECRET: ${{ secrets.FLOW_SECRET }}
          SHIP: ${{ inputs.ship }}
          EVENT: ${{ inputs.event }}          # Arrived | Departed
          PORT: ${{ inputs.port }}
          EST: ${{ inputs.est }}
          LOCAL: ${{ inputs.local }}
          LINK: ${{ inputs.link }}
        run: |
          set -euo pipefail

          if [ -z "${FLOW_URL:-}" ] || [ -z "${FLOW_SECRET:-}" ]; then
            echo "::warning ::FLOW_URL or FLOW_SECRET not set; skipping webhook notify."
            exit 0
          fi

          if [ "${EVENT}" = "Arrived" ]; then
            VERB_PHRASE="Arrived at"
          else
            VERB_PHRASE="Departed from"
          fi

          TITLE="${SHIP} ${VERB_PHRASE} ${PORT} at ${EST}"
          if [ -n "${LOCAL}" ]; then
            TITLE="${TITLE}. The local time to the port is ${LOCAL}"
          fi

          GUID=$(python - <<'PY'
import hashlib, os
ship=os.environ['SHIP']; event=os.environ['EVENT']; port=os.environ['PORT']; est=os.environ['EST']
key=f"manual|{ship}|{event}|{port}|{est}"
print(hashlib.sha1(key.encode()).hexdigest()))
PY
)

          PUB=$(date -u -R)

          echo "Posting webhook for ${SHIP} ${EVENT} @ ${PORT}"
          curl -sS -X POST "$FLOW_URL" \
            -H "Content-Type: application/json" \
            -H "x-shipalerts-secret: $FLOW_SECRET" \
            -d @- <<JSON
{
  "ShipName":   "$SHIP",
  "EventType":  "$EVENT",
  "PortName":   "$PORT",
  "ESTLabel":   "$EST",
  "LocalLabel": "$LOCAL",
  "Link":       "$LINK",
  "Title":      "$TITLE",
  "GuidKey":    "$GUID",
  "PubDate":    "$PUB",
  "Description": ""
}
JSON

      # ---------- Restore (copy latest.xml -> latest-all.xml) ----------
      - name: Restore from latest.xml (RestorePrevious mode)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          DEST_FILE: docs/${{ inputs.filename }}
          SRC_FILE: docs/latest.xml
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -e
          echo "Source:  $SRC_FILE"
          echo "Dest:    $DEST_FILE"

          if [ ! -f "$SRC_FILE" ]; then
            echo "ERROR: $SRC_FILE not found. Cannot restore."
            exit 1
          fi

          mkdir -p "$(dirname "$DEST_FILE")"
          cp "$SRC_FILE" "$DEST_FILE"

          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            cp "$SRC_FILE" docs/latest_all.xml
            git add docs/latest_all.xml
            echo "Also restored docs/latest_all.xml from latest.xml."
          fi

          git add "$DEST_FILE"
          git commit -m "restore: copy latest.xml -> $DEST_FILE" || echo "No changes to commit"
          git push || echo "No changes pushed"
          echo "Restore complete."