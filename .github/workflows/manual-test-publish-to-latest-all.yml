name: Manual Publish or Restore

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (copy latest.xml → latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false
      notify:
        description: "Send email notification (Publish only)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Publish ----------
      - name: Validate inputs (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -e
          if [ -z "${{ inputs.ship }}" ] || [ -z "${{ inputs.event }}" ] || [ -z "${{ inputs.port }}" ] || [ -z "${{ inputs.est }}" ]; then
            echo "Missing one or more required inputs: ship, event, port, est"
            exit 1
          fi

      - name: Setup Python (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -euo pipefail
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            --nonce "${{ github.run_id }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

          echo "---- HEAD of written file ----"
          sed -n '1,80p' "docs/${{ inputs.filename }}" || true
          echo "--------------------------------"

      - name: Commit publish
        if: ${{ inputs.mode == 'Publish' }}
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -euo pipefail
          if ! git status --porcelain | grep -q "$TARGET_FILE"; then
            echo "::error ::No changes detected in $TARGET_FILE after publisher ran."
            exit 1
          fi

          git add "$TARGET_FILE"
          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            git add docs/latest_all.xml || true
          fi

          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}"
          git pull --rebase || true
          git push

      # ---------- Restore (copy latest.xml -> latest-all.xml) ----------
      - name: Restore from latest.xml (RestorePrevious)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          DEST_FILE: docs/${{ inputs.filename }}
          SRC_FILE: docs/latest.xml
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -e
          echo "Source:  $SRC_FILE"
          echo "Dest:    $DEST_FILE"

          if [ ! -f "$SRC_FILE" ]; then
            echo "ERROR: $SRC_FILE not found. Cannot restore."
            exit 1
          fi

          mkdir -p "$(dirname "$DEST_FILE")"
          cp "$SRC_FILE" "$DEST_FILE"

          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            cp "$SRC_FILE" docs/latest_all.xml
            git add docs/latest_all.xml
            echo "Also restored docs/latest_all.xml from latest.xml."
          fi

          git add "$DEST_FILE"
          git commit -m "restore: copy latest.xml -> $DEST_FILE" || echo "No changes to commit"
          git pull --rebase || true
          git push || echo "No changes pushed"
          echo "Restore complete."

      # ---------- Email notification (Publish only) ----------
      - name: Send email (Publish)
        if: ${{ inputs.mode == 'Publish' && inputs.notify == true }}
        env:
          SMTP_HOST:   ${{ secrets.SMTP_HOST }}
          SMTP_PORT:   ${{ secrets.SMTP_PORT }}
          SMTP_USER:   ${{ secrets.SMTP_USER }}
          SMTP_PASS:   ${{ secrets.SMTP_PASS }}
          ALERT_FROM:  ${{ secrets.ALERT_FROM }}
          ALERT_INBOX: ${{ secrets.ALERT_INBOX }}
          TARGET_FILE: docs/${{ inputs.filename }}
        run: |
          python - << 'PY'
import os, ssl, smtplib, mimetypes
from email.message import EmailMessage

smtp_host = os.environ["SMTP_HOST"]
smtp_port = int(os.environ.get("SMTP_PORT","587"))
smtp_user = os.environ["SMTP_USER"]
smtp_pass = os.environ["SMTP_PASS"]
sender    = os.environ["ALERT_FROM"]
to        = os.environ["ALERT_INBOX"]
fname     = os.environ["TARGET_FILE"]

ship   = """${{ inputs.ship }}"""
event  = """${{ inputs.event }}"""
port   = """${{ inputs.port }}"""
est    = """${{ inputs.est }}"""
local  = """${{ inputs.local }}"""
link   = """${{ inputs.link }}"""

subj = f"DCL Ship Alerts: {ship} {event} " + ("at " if event=="Arrived" else "from ") + port

html = f"""
<div style="font-family:Segoe UI,Arial,sans-serif">
  <h3 style="margin:0 0 8px 0;">{ship} — {event}</h3>
  <p style="margin:4px 0;"><b>Port:</b> {port}</p>
  <p style="margin:4px 0;"><b>EST:</b> {est}</p>
  {f'<p style="margin:4px 0;"><b>Local:</b> {local}</p>' if local else ''}
  {f'<p style="margin:4px 0;"><b>Link:</b> <a href="{link}">{link}</a></p>' if link and link != '#' else ''}
  <p style="margin:8px 0 0 0;"><i>Updated file:</i> {fname}</p>
</div>
"""

msg = EmailMessage()
msg["From"] = sender
msg["To"] = to
msg["Subject"] = subj
msg.set_content(f"{ship} {event} " + ("at " if event=="Arrived" else "from ") + f"{port}\nEST: {est}\n" + (f"Local: {local}\n" if local else "") + (f"Link: {link}\n" if link and link != "#" else "") + f"\nUpdated file: {fname}")
msg.add_alternative(html, subtype="html")

# Attach the target XML for convenience
if os.path.exists(fname):
    import pathlib, mimetypes
    ctype, _ = mimetypes.guess_type(fname)
    maintype, subtype = (ctype.split("/",1) if ctype else ("application","octet-stream"))
    with open(fname, "rb") as f:
        msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=pathlib.Path(fname).name)

context = ssl.create_default_context()
with smtplib.SMTP(smtp_host, smtp_port, timeout=30) as s:
    s.starttls(context=context)
    s.login(smtp_user, smtp_pass)
    s.send_message(msg)
print("Email sent.")
PY
