name: Manual Publish or Restore

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose Publish (write test) or RestorePrevious (copy latest.xml â†’ latest-all.xml)"
        required: true
        type: choice
        options: [Publish, RestorePrevious]
        default: Publish
      ship:
        description: "Ship name (e.g., Disney Wonder)"
        required: false
        type: string
      event:
        description: "Event"
        required: false
        type: choice
        options: [Arrived, Departed]
      port:
        description: "Port (e.g., Melbourne, Australia)"
        required: false
        type: string
      est:
        description: "EST label (e.g., Nov 08, 01:57 PM EST)"
        required: false
        type: string
      local:
        description: "Local time label (optional)"
        required: false
        type: string
        default: ""
      link:
        description: "Detail link (optional)"
        required: false
        type: string
        default: "#"
      filename:
        description: "Target filename in docs/ (default latest-all.xml)"
        required: false
        type: string
        default: "latest-all.xml"
      also_underscore:
        description: "Also write/restore docs/latest_all.xml"
        required: false
        type: boolean
        default: false
      notify:
        description: "Send email notification (Publish only)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

concurrency:
  group: "manual-publish-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  publish-or-restore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.ref }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ---------- Publish ----------
      - name: Validate inputs (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -e
          if [ -z "${{ inputs.ship }}" ] || [ -z "${{ inputs.event }}" ] || [ -z "${{ inputs.port }}" ] || [ -z "${{ inputs.est }}" ]; then
            echo "Missing one or more required inputs: ship, event, port, est"
            exit 1
          fi

      - name: Setup Python (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run publisher (Publish)
        if: ${{ inputs.mode == 'Publish' }}
        run: |
          set -euo pipefail
          python .github/scripts/publish_latest_all.py \
            --ship "${{ inputs.ship }}" \
            --event "${{ inputs.event }}" \
            --port "${{ inputs.port }}" \
            --est "${{ inputs.est }}" \
            --local "${{ inputs.local }}" \
            --link "${{ inputs.link }}" \
            --filename "${{ inputs.filename }}" \
            --nonce "${{ github.run_id }}" \
            $([ "${{ inputs.also_underscore }}" = "true" ] && echo "--also-underscore")

          echo "---- HEAD of written file ----"
          sed -n '1,80p' "docs/${{ inputs.filename }}" || true
          echo "--------------------------------"

      - name: Commit publish (robust)
        if: ${{ inputs.mode == 'Publish' }}
        env:
          TARGET_FILE: docs/${{ inputs.filename }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -euo pipefail
          git fetch --all
          git checkout "$GITHUB_REF_NAME"
          git pull --rebase --autostash || true

          if ! git status --porcelain | grep -q "$TARGET_FILE"; then
            echo "No detected changes to $TARGET_FILE; skipping commit."
            exit 0
          fi

          git add "$TARGET_FILE"
          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            git add docs/latest_all.xml || true
          fi

          git commit -m "manual publish: ${{ inputs.ship }} ${{ inputs.event }} at ${{ inputs.port }}" || {
            echo "Nothing to commit."; exit 0;
          }

          if ! git push; then
            echo "First push failed; fetching & rebasing then retrying..."
            git fetch --all
            git pull --rebase --autostash || true
            git push
          fi

          echo "Publish committed & pushed."

      # ---------- Restore (copy latest.xml -> latest-all.xml) ----------
      - name: Restore from latest.xml (RestorePrevious)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          DEST_FILE: docs/${{ inputs.filename }}
          SRC_FILE: docs/latest.xml
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -e
          echo "Source:  $SRC_FILE"
          echo "Dest:    $DEST_FILE"

          if [ ! -f "$SRC_FILE" ]; then
            echo "ERROR: $SRC_FILE not found. Cannot restore."
            exit 1
          fi

          mkdir -p "$(dirname "$DEST_FILE")"
          cp "$SRC_FILE" "$DEST_FILE"

          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            cp "$SRC_FILE" docs/latest_all.xml
            echo "Also restored docs/latest_all.xml from latest.xml."
          fi

      - name: Commit restore (robust)
        if: ${{ inputs.mode == 'RestorePrevious' }}
        env:
          DEST_FILE: docs/${{ inputs.filename }}
          ALSO_UNDERSCORE: ${{ inputs.also_underscore }}
        run: |
          set -euo pipefail
          git fetch --all
          git checkout "$GITHUB_REF_NAME"
          git pull --rebase --autostash || true

          git add "$DEST_FILE"
          if [ "$ALSO_UNDERSCORE" = "true" ]; then
            git add docs/latest_all.xml || true
          fi

          git commit -m "restore: copy latest.xml -> $DEST_FILE" || {
            echo "No changes to commit."; exit 0;
          }

          if ! git push; then
            echo "First push failed; fetching & rebasing then retrying..."
            git fetch --all
            git pull --rebase --autostash || true
            git push
          fi

          echo "Restore committed & pushed."

      # ---------- Email notification (Publish only; attaches JSON, not XML) ----------
      - name: Send email (Publish, JSON test)
        if: ${{ inputs.mode == 'Publish' && inputs.notify }}
        shell: python
        env:
          SMTP_HOST:   ${{ secrets.SMTP_HOST }}
          SMTP_PORT:   ${{ secrets.SMTP_PORT }}
          SMTP_USER:   ${{ secrets.SMTP_USER }}
          SMTP_PASS:   ${{ secrets.SMTP_PASS }}
          ALERT_FROM:  ${{ secrets.ALERT_FROM }}
          ALERT_INBOX: ${{ secrets.ALERT_INBOX }}
        run: |
          import os, ssl, smtplib, json
          from email.message import EmailMessage
          from email.utils import formatdate

          smtp_host = os.environ["SMTP_HOST"]
          smtp_port = int(os.environ.get("SMTP_PORT","587"))
          smtp_user = os.environ["SMTP_USER"]
          smtp_pass = os.environ["SMTP_PASS"]
          sender    = os.environ["ALERT_FROM"]
          to        = os.environ["ALERT_INBOX"]

          ship   = """${{ inputs.ship }}"""
          event  = """${{ inputs.event }}"""
          port   = """${{ inputs.port }}"""
          est    = """${{ inputs.est }}"""
          local  = """${{ inputs.local }}"""
          link   = """${{ inputs.link }}"""

          title = f"{ship} " + ("Arrived at " if event == "Arrived" else "Departed from ") + f"{port} at {est}"
          subj  = f"DCL Ship Alerts (TEST JSON): {ship} {event} " + ("at " if event=="Arrived" else "from ") + port

          payload = {
            "ShipName":  ship,
            "EventType": event,             # Arrived | Departed
            "PortName":  port,
            "ESTLabel":  est,
            "LocalLabel": local or "",
            "Link":       "" if (not link or link == "#") else link,
            "Title":      title,
            "GuidKey":    "",
            "PubDate":    formatdate(usegmt=True),
            "Description": f"Manual publish test for {ship}"
          }

          # Build email (no XML attachment; JSON only)
          msg = EmailMessage()
          msg["From"] = sender
          msg["To"] = to
          msg["Subject"] = subj
          msg.set_content(
            f"{title}\nEST: {est}\n"
            + (f"Local: {local}\n" if local else "")
            + (f"Link: {link}\n" if link and link != "#" else "")
            + "\nAttachment: shipalert.json"
          )
          msg.add_alternative(f"<pre style='font-family:Consolas,monospace'>{json.dumps(payload, indent=2)}</pre>", subtype="html")

          # Attach JSON (what your Flow expects)
          data = json.dumps(payload, ensure_ascii=False).encode("utf-8")
          msg.add_attachment(data, maintype="application", subtype="json", filename="shipalert.json")

          context = ssl.create_default_context()
          with smtplib.SMTP(smtp_host, smtp_port, timeout=30) as s:
            s.starttls(context=context)
            s.login(smtp_user, smtp_pass)
            s.send_message(msg)
          print("Email with shipalert.json sent.")
